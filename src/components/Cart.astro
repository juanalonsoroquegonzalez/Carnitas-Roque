---
import Plato from "../components/Plat.astro";
---
<div id="phone-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-xl p-6 w-80 shadow-lg">
    <input type="text" id="phone-input-modal" placeholder="55 1234 5678" class="w-full border px-3 py-2 rounded mb-4">
    <div class="flex justify-end gap-2">
      <button id="phone-cancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 transition">Cancelar</button>
      <button id="phone-submit" class="px-4 py-2 rounded bg-yellow-600 text-white hover:bg-yellow-500 transition">Guardar</button>
    </div>
  </div>
</div>

<button
  id="order-toggle"
  class="fixed bottom-6 right-6 z-50
         px-5 py-3 rounded-full
         bg-gradient-to-r from-yellow-500 to-orange-500
         text-white font-medium
         shadow-lg
         hover:from-yellow-600 hover:to-orange-600
         hover:shadow-xl
         transition-all duration-300
         active:scale-95"
>
  üõí Hacer Pedido
  <span
    id="cart-count"
    class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full"
  >
    0
  </span>
</button>
<!--
<button
  id="toggle-plato"
  class="fixed bottom-20 right-6 z-50 px-5 py-3 bg-red-600 text-white p-4 rounded-full shadow-lg hover:bg-red-700 transition"
>
  üçΩÔ∏è Plato
</button>

<div
  id="plate-container"
  class="fixed bottom-36 right-6 z-50
         sm:w-[180px] md:w-[240px]
         sm:max-h-[400px] md:max-h-[560px]
         overflow-y-auto
         bg-white rounded-2xl shadow-2xl
         transform transition-all duration-300 ease-in-out
         scale-0 opacity-0 pointer-events-none"
>
  <Plato />
</div>
-->
<!-- Panel de pedidos -->
<div
  id="order-panel"
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex justify-center items-center hidden z-50"
>
  <div
    class="bg-white/80 w-11/12 max-w-4xl p-4 md:p-6 rounded-2xl shadow-xl relative
           flex flex-col md:flex-row gap-4 md:gap-6
           max-h-[90vh] overflow-hidden"
  >
    <button
      id="close-panel"
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 font-bold text-lg"
    >
      &times;
    </button>

    <!-- üü° Pedidos activos -->
    <div class="w-full md:w-120 flex flex-col h-90 md:h-[600px]">

      <!-- Header fijo -->
      <div id="pedido-general" class="pb-2">
        <h3 class="text-lg font-semibold">Pedidos</h3>
      </div>

      <!-- Scroll SOLO aqu√≠ -->
      <div
        id="active-orders"
        class="flex-1 overflow-y-auto space-y-2 py-2 border rounded-lg p-4"
      ></div>

      <!-- Footer fijo -->
      <div
        id="total-general"
        class="text-right font-bold text-lg pt-2"
      >
        Total: $0.00
      </div>
    </div>

    <!-- üü¢ Info cliente -->
    <div class="w-full flex-1 flex flex-col gap-3 overflow-y-auto">
      <h2 class="text-2xl font-bold mb-2">Especificaciones del Pedido</h2>

      <input
        type="text"
        id="name"
        placeholder="Nombre"
        class="w-full px-3 py-2 border rounded"
      />

      <div
        id="address-container"
        class="flex flex-col md:flex-row gap-2 hidden"
      >
        <input
          type="text"
          id="address"
          placeholder="Domicilio"
          class="flex-1 px-3 py-2 border rounded"
        />

        <button
          id="get-location"
          class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300 text-sm hidden"
        >
          Compartir ubicaci√≥n
        </button>
      </div>

      <textarea
        id="comments"
        placeholder="Comentarios del pedido"
        class="w-full px-3 py-2 border rounded"
      ></textarea>
      <div class="flex gap-4 mb-2">
      <label class="flex items-center gap-2 cursor-pointer text-sm">
        <input
          type="radio"
          name="deliveryType"
          value="pickup"
          checked
          class="accent-orange-500"
        />
        Recoger pedido
      </label>

      <label class="flex items-center gap-2 cursor-pointer text-sm">
        <input
          type="radio"
          name="deliveryType"
          value="delivery"
          class="accent-orange-500"
        />
        Pedido a domicilio
      </label>
    </div>
      <button
        id="whatsapp-order"
        class="w-full bg-green-600 text-white py-3 rounded-lg
              hover:bg-green-500 transition-colors
              flex items-center justify-center gap-2"
      >
        üì≤ Pedir Carrito por WhatsApp
      </button>
    </div>
  </div>
</div>

</div>
<script>
/* =====================
   ESTADO GLOBAL
===================== */

declare global {
  interface Window {
    cart: any[];
    userPhone?: string;
    updateCartCount: () => void;
    removeFromPedido: (id: any) => void;
  }
}

window.cart = [];

/* =====================
   ELEMENTOS UI
===================== */

const orderToggle = document.getElementById('order-toggle');
const orderPanel = document.getElementById('order-panel');
const closePanel = document.getElementById('close-panel');

const activeOrdersContainer = document.getElementById('active-orders');
const totalDiv = document.getElementById('total-general');

/* =====================
   PANEL PEDIDOS
===================== */

orderToggle?.addEventListener('click', () => {
  orderPanel?.classList.remove('hidden');
  renderCart();
});

closePanel?.addEventListener('click', () => {
  orderPanel?.classList.add('hidden');
});

/* =====================
   RENDER CARRITO
===================== */
function renderCart() {
  if (!activeOrdersContainer || !totalDiv) return;

  const pedido = window.getOrCreatePedido();

  if (pedido.pedido_detalle.length === 0) {
    activeOrdersContainer.innerHTML =
      '<p class="text-gray-500 text-sm">Carrito vac√≠o</p>';
    totalDiv.textContent = 'Total: $0';
    return;
  }

  let total = 0;

  activeOrdersContainer.innerHTML = (pedido.pedido_detalle as any[])
    .map((item: any) => {
      let sub = 0;
      
      if (item.modo === 'pesos' || item.modo === 'gramos') {
        sub = Number(item.precio_unitario);
      } else {
        const cantidad = Number(item.cantidad);
        const precio = Number(item.precio_unitario);
        sub = cantidad * precio;
      }

      total += sub;
      return `
  <div class="flex justify-between items-center p-4 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-200">
    
    <!-- Info del producto -->
    <div class="flex flex-col">
      <div class="font-semibold text-gray-800 text-lg">
        ${item.producto.nombre}
        <span class="text-sm text-gray-500">- ${item.tipo || ''}</span>
      </div>
      <div class="text-sm text-gray-500 mt-1">
        ${item.cantidad} ${item.unidad}
      </div>
    </div>

    <!-- Precio + eliminar -->
    <div class="flex items-center gap-3">
      <span class="font-semibold text-gray-900 text-lg">
        $${sub.toFixed(2)}
      </span>

      <button
        class="text-red-500 hover:text-red-700 transition"
        onclick="removeFromPedido(${item.id})"
        title="Eliminar"
      >
        <svg xmlns="http://www.w3.org/2000/svg"
             class="w-5 h-5"
             fill="none"
             viewBox="0 0 24 24"
             stroke="currentColor"
             stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m2 0H7m3-3h4a1 1 0 011 1v1H9V5a1 1 0 011-1z" />
        </svg>
      </button>
    </div>

  </div>
`;
    })
    .join('');

  totalDiv.innerHTML = `<strong>Total: $${total.toFixed(2)}</strong>`;
}

/* =====================
   WHATSAPP
===================== */
document.getElementById('whatsapp-order')?.addEventListener('click', () => {
  const pedido = window.getOrCreatePedido();
  if (pedido.pedido_detalle.length === 0) return alert('Carrito vac√≠o');

  const name = (document.getElementById('name') as HTMLInputElement)?.value;
  const phone = (document.getElementById('phone-order') as HTMLInputElement)?.value;
  const address = (document.getElementById('address') as HTMLInputElement)?.value;
  const comments = (document.getElementById('comments') as HTMLTextAreaElement)?.value;

  let msg = `*Nuevo pedido*\n\n`;

  if (name) msg += `${name}\n`;      
  if (phone) msg += `${phone}\n`;    
  if (address) msg += `${address}\n`; 
  if (comments) msg += `${comments}\n`;

  msg += `\n*Pedido:*\n`;

  let total = 0;

  pedido.pedido_detalle.forEach((item, i) => {
    const sub = item.precio_unitario * item.cantidad;
    
    if(item.modo === 'pesos' || item.modo === 'gramos'){
      total += Number(item.precio_unitario);
      msg += `${i + 1}. ${item.producto.nombre} (${item.cantidad} ${item.unidad || ''}) ‚Üí $${Number(item.precio_unitario).toFixed(2)}\n`;
    }
    else{
      total += sub;
      msg += `${i + 1}. ${item.producto.nombre} x ${item.cantidad} ${item.unidad || ''} ‚Üí $${sub.toFixed(2)}\n`;
    }
    
  });

  msg += `\n*Total: $${total.toFixed(2)}*`;

  const businessPhone = '523751384779';
  window.open(
    `https://wa.me/${businessPhone}?text=${encodeURIComponent(msg)}`,
    '_blank'
  );

  window.activePedido = undefined;

  // Actualizar UI
  renderCart();
  window.updateCartCount();
});
/* =====================
   GEOLOCALIZACION
===================== */

document.getElementById('get-location')?.addEventListener('click', () => {
  const addressInput = document.getElementById('address') as HTMLInputElement;
  if (!navigator.geolocation) return alert('Geolocalizaci√≥n no soportada');

  navigator.geolocation.getCurrentPosition(
    pos => {
      addressInput.value = `Lat: ${pos.coords.latitude.toFixed(5)}, Lon: ${pos.coords.longitude.toFixed(5)}`;
    },
    () => alert('No se pudo obtener la ubicaci√≥n')
  );
});

window.updateCartCount = function() {
  const badge = document.getElementById('cart-count');
  if (!badge) return;

  const pedido = window.getOrCreatePedido();

  const totalItems = pedido.pedido_detalle.length;

  badge.textContent = totalItems.toString();

  badge.style.display = 'flex';
}

  const radios = document.querySelectorAll('input[name="deliveryType"]');
  const addressContainer = document.getElementById('address-container');

  function updateDeliveryUI() {
    const selected = (document.querySelector('input[name="deliveryType"]:checked') as HTMLInputElement)?.value;

    if (selected === 'pickup') {
      addressContainer?.classList.add('hidden');
    } else {
      addressContainer?.classList.remove('hidden');
    }
  }

  radios.forEach(radio => {
    radio.addEventListener('change', updateDeliveryUI);
  });

  // Estado inicial
  updateDeliveryUI();


window.removeFromPedido = function(id) {
  const pedido = window.getOrCreatePedido();

  pedido.pedido_detalle = pedido.pedido_detalle.filter(
    item => item.id !== id
  );

  renderCart();
  window.updateCartCount?.();
};
</script>