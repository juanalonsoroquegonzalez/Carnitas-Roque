<section class="bg-gray-100 py-12">
  <div class="max-w-6xl mx-auto px-6">
    <h2 class="text-3xl font-bold text-center mb-10">Nuestro Menú de Carnitas</h2>

    <div class="grid md:grid-cols-3 gap-8">
      <!-- Tarjeta 1 -->
       <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/receta.jpg" alt="Torta de carnitas" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Carnitas</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Deliciosas carnitas y cueritos acompañadas de salsa de jitomate cruda y doraditas.
            </p>
            <span class="text-lg font-bold text-yellow-700 mb-4">$340 MXN / Kg</span>
            <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">
              Elige tu tipo:
            </p>

            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-1"
                  value="Carnitas"
                  class="hidden peer"
                  checked
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Carnitas
                </span>
              </label>

              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-1"
                  value="Cueritos"
                  class="hidden peer"
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Cueritos
                </span>
              </label>

              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-1"
                  value="Surtido"
                  class="hidden peer"
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Surtido
                </span>
              </label>
            </div>
          </div>
           <!-- Modo de compra -->
          <div class="mb-3">
            <p class="text-sm font-medium text-gray-700 mb-2">
              Forma de compra:
            </p>

            <div class="flex gap-3">
              <label class="cursor-pointer">
                <input type="radio" name="modo-1" value="gramos" class="hidden peer" checked>
                <span
                  class="px-3 py-1 rounded-full text-sm border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition">
                  Por gramos
                </span>
              </label>

              <label class="cursor-pointer">
                <input type="radio" name="modo-1" value="pesos" class="hidden peer">
                <span
                  class="px-3 py-1 rounded-full text-sm border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition">
                  Por pesos
                </span>
              </label>
            </div>
          </div>
          <div class="mt-auto">
            <!-- Contador de cantidad -->
            <div class="flex items-center gap-2 mb-2">
              <button
                class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition"
                onclick="updateQty(this, -1, this)">
                -
              </button>

              <input
                type="tel"
                value="100 g"
                class="qty-input w-20 text-center border-t border-b border-gray-200"
                onblur="handleQtyBlur(this)"
              >

              <button
                class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition"
                onclick="updateQty(this, 1, this)">
                +
              </button>
            </div>

            <!-- Botones lado a lado -->
            <div class="flex gap-2">
              <button
                class="add-cart-btn btn-primary flex-1"
                data-id="1"
                data-name="Carnitas"
                data-price-kg="340"
              >
                Add carrito
              </button>
            </div>
          </div>

          </div>
        </div>

        <!-- Tarjeta 2 -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/torta.jpg" alt="Torta de carnitas" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Torta de Carnitas</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Bolillo salado para torta con carnitas, salsa de jitomate, cebolla curtida, salsa brava y doraditas.
            </p>
            <span class="text-lg font-bold text-yellow-700 mb-4">$55 MXN</span>
            <div class="mb-4">
              <p class="text-sm font-medium text-gray-700 mb-2">
                Elige tu tipo:
              </p>

              <div class="flex gap-3">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="tipo-2"
                    value="Carnitas"
                    class="hidden peer"
                    checked
                  />
                  <span
                    class="px-3 py-1 rounded-full text-sm
                          border border-gray-300
                          peer-checked:bg-gradient-to-r
                          peer-checked:from-yellow-500 peer-checked:to-orange-500
                          peer-checked:text-white
                          peer-checked:border-transparent
                          transition-all duration-200"
                  >
                    Carnitas
                  </span>
                </label>

                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="tipo-2"
                    value="Cueritos"
                    class="hidden peer"
                  />
                  <span
                    class="px-3 py-1 rounded-full text-sm
                          border border-gray-300
                          peer-checked:bg-gradient-to-r
                          peer-checked:from-yellow-500 peer-checked:to-orange-500
                          peer-checked:text-white
                          peer-checked:border-transparent
                          transition-all duration-200"
                  >
                    Cueritos
                  </span>
                </label>

                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="tipo-2"
                    value="Surtido"
                    class="hidden peer"
                  />
                  <span
                    class="px-3 py-1 rounded-full text-sm
                          border border-gray-300
                          peer-checked:bg-gradient-to-r
                          peer-checked:from-yellow-500 peer-checked:to-orange-500
                          peer-checked:text-white
                          peer-checked:border-transparent
                          transition-all duration-200"
                  >
                    Surtido
                  </span>
                </label>
              </div>
            </div>
           <div class="mt-auto">
            <!-- Contador de cantidad -->
            <div class="flex items-center gap-2 mb-2">
              <button class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition-colors" onclick="updateQty(this, -1)">-</button> 
              <input type="text" value="0" class="qty-input w-12 text-center border-t border-b border-gray-200" readonly> 
              <button class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition-colors" onclick="updateQty(this, 1)">+</button>
            </div>

            <!-- Botones lado a lado -->
            <div class="flex gap-2">
              <button 
                class="add-cart-btn btn-primary flex-1"
                data-id="2"
                data-name="Torta de Carnitas"
                data-price="55">
                Add carrito
              </button>

              <button 
                class="add-plate-btn btn-primary w-26"
                data-id="2"
                data-name="Torta de Carnitas"
                data-price="55">
                Add Plato
              </button>
            </div>
          </div>

          </div>
        </div>

        <!-- Tarjeta 3 -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/Carnitas.jpg" alt="Tacos de carnitas" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Tacos de Carnitas</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Tortilla de maiz de tamaño normal con carnitas con cebolla, cilantro, repollo, salsa de jitomate cruda, salsa picante de tomate y guacamole.
            </p>
            <span class="text-lg font-bold text-yellow-700 mb-4">$25 MXN</span>
            <div class="mb-4">
              <p class="text-sm font-medium text-gray-700 mb-2">
                Elige tu tipo:
              </p>

              <div class="flex gap-3">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="tipo-3"
                    value="Carnitas"
                    class="hidden peer"
                    checked
                  />
                  <span
                    class="px-3 py-1 rounded-full text-sm
                          border border-gray-300
                          peer-checked:bg-gradient-to-r
                          peer-checked:from-yellow-500 peer-checked:to-orange-500
                          peer-checked:text-white
                          peer-checked:border-transparent
                          transition-all duration-200"
                  >
                    Carnitas
                  </span>
                </label>

                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="tipo-3"
                    value="Cueritos"
                    class="hidden peer"
                  />
                  <span
                    class="px-3 py-1 rounded-full text-sm
                          border border-gray-300
                          peer-checked:bg-gradient-to-r
                          peer-checked:from-yellow-500 peer-checked:to-orange-500
                          peer-checked:text-white
                          peer-checked:border-transparent
                          transition-all duration-200"
                  >
                    Cueritos
                  </span>
                </label>

                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="tipo-3"
                    value="Surtido"
                    class="hidden peer"
                  />
                  <span
                    class="px-3 py-1 rounded-full text-sm
                          border border-gray-300
                          peer-checked:bg-gradient-to-r
                          peer-checked:from-yellow-500 peer-checked:to-orange-500
                          peer-checked:text-white
                          peer-checked:border-transparent
                          transition-all duration-200"
                  >
                    Surtido
                  </span>
                </label>
              </div>
            </div>
           <div class="mt-auto">
            <!-- Contador de cantidad -->
            <div class="flex items-center gap-2 mb-2">
              <button class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition-colors" onclick="updateQty(this, -1)">-</button> 
              <input type="text" value="0" class="qty-input w-12 text-center border-t border-b border-gray-200" readonly> 
              <button class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition-colors" onclick="updateQty(this, 1)">+</button>
            </div>

            <!-- Botones lado a lado -->
            <div class="flex gap-2">
              <button 
                class="add-cart-btn btn-primary flex-1"
                data-id="3"
                data-name="Tacos de Carnitas"
                data-price="25">
                Add carrito
              </button>

              <button 
                class="add-plate-btn btn-primary w-26"
                data-id="3"
                data-name="Tacos de Carnitas"
                data-price="25">
                Add Plato
              </button>
            </div>
          </div>

          </div>
        </div>

        <!-- Tarjeta 4 -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/botanero.jpg" alt="Tacos Dorados" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Tacos Dorados</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Tortilla de maiz de tamaño normal con carnitas con cebolla, salsa de jitomate, cilantro, repollo, salsa de jitomate cruda, salsa picante de tomate y guacamole.
            </p>
            <span class="text-lg font-bold text-yellow-700 mb-4">$9 MXN</span>
            <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">
              Elige tu tipo:
            </p>

            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-4"
                  value="Papa"
                  class="hidden peer"
                  checked
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Papa
                </span>
              </label>
            </div>
          </div>
            

           <div class="mt-auto">
            <!-- Contador de cantidad -->
            <div class="flex items-center gap-2 mb-2">
              <button class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition-colors" onclick="updateQty(this, -1)">-</button> 
              <input type="text" value="0" class="qty-input w-12 text-center border-t border-b border-gray-200" readonly> 
              <button class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition-colors" onclick="updateQty(this, 1)">+</button>
            </div>

            <!-- Botones lado a lado -->
            <div class="flex gap-2">
              <button 
                class="add-cart-btn btn-primary flex-1"
                data-id="4"
                data-name="Tacos Dorados"
                data-price="9">
                Add carrito
              </button>

              <button 
                class="add-plate-btn btn-primary w-26"
                data-id="4"
                data-name="Tacos Dorados"
                data-price="9">
                Add Plato
              </button>
            </div>
          </div>

          </div>
        </div>

        <!-- Tarjeta 5 -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/dael.jpg" alt="Tacos Dorados con Carnitas" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Tacos Dorados con Carnitas</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Tortilla de maiz de tamaño normal con carnitas con cebolla, salsa de jitomate, cilantro, repollo, salsa de jitomate cruda, salsa picante de tomate y guacamole.
            </p>
            <span class="text-lg font-bold text-yellow-700 mb-4">$22 MXN</span>
            <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">
              Elige tu tipo:
            </p>

            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-5"
                  value="Carnitas"
                  class="hidden peer"
                  checked
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Carnitas
                </span>
              </label>

              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-5"
                  value="Cueritos"
                  class="hidden peer"
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Cueritos
                </span>
              </label>

              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-5"
                  value="Surtido"
                  class="hidden peer"
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Surtido
                </span>
              </label>
            </div>
          </div>
                    <div class="mt-auto">
            <div class="flex items-center gap-2 mb-2">
              <button class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition-colors" onclick="updateQty(this, -1)">-</button> 
              <input type="text" value="0" class="qty-input w-12 text-center border-t border-b border-gray-200" readonly> 
              <button class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition-colors" onclick="updateQty(this, 1)">+</button>
            </div>

            <div class="flex gap-2">
              <button 
                class="add-cart-btn btn-primary flex-1"
                data-id="5"
                data-name="Tacos Dorados con Carnitas"
                data-price="22">
                Add carrito
              </button>

              <button 
                class="add-plate-btn btn-primary w-26"
                data-id="5"
                data-name="Tacos Dorados con Carnitas"
                data-price="22">
                Add Plato
              </button>
            </div>
          </div>
          </div>
        </div>

    </div>
  </div>
</section>

<script>
/* =========================
   TIPOS
========================= */

import { TRANSITION_PAGE_LOAD } from "astro:transitions/client";

type Product = {
  id: number;
  name: string;
  price: number;
  qty: number;
  modo?: 'gramos' | 'pesos' | undefined;
  unidad?: 'g' | 'pza';
  tipo: string;
};

interface ProductoPedido {
  id: number;
  nombre: string;
}

interface PedidoDetalle {
  id: number;
  cantidad: number;
  precio_unitario: number;
  modo?: 'gramos' | 'pesos';
  unidad: 'g' | 'pza';
  tipo: string;
  producto: ProductoPedido;
}

interface ActivePedido {
  numero_pedido: number;
  telefono_cliente: string;
  fecha: string;
  pedido_detalle: PedidoDetalle[];
}

/* =========================
   ESTADO GLOBAL
========================= */

declare global {
  interface Window {
    userPhone?: string;
    cart: any[];
    activePedido?: ActivePedido;
    updateQty: (btn: HTMLButtonElement, delta: number) => void;
    handleQtyBlur: (input: HTMLInputElement) => void;
    sendPedidoWhatsApp: () => void;
  }
}

window.cart = [];

/* =========================
   TELEFONO
========================= */

const savedPhone = localStorage.getItem('userPhone');
if (savedPhone) window.userPhone = savedPhone;

/* =========================
   UTILIDADES UI
========================= */

window.updateQty = function (button, delta) {
  const card = button.closest('.bg-white.rounded-2xl');
  if (!card) return;

  const input = card.querySelector('input.qty-input') as HTMLInputElement;
  if (!input) return;

  const modo = (card.querySelector('input[name="modo-1"]:checked') as HTMLInputElement)?.value;

  let value = parseInt(input.value.replace(/[^\d]/g, ''), 10) || 0;
  value += delta;

  if (modo === 'gramos') {
    if (value < 100) value = 100;
    input.value = `${value} g`;
  } else if (modo === 'pesos') {
    if (value < 50) value = 50;
    input.value = `$${value}`;
  } else {
    if (value < 1) value = 1;
    input.value = value.toString();
  }

  input.dataset.value = value.toString();
};

window.handleQtyBlur = function (input) {
  const card = input.closest('.bg-white.rounded-2xl');
  if (!card) return;

  const modo = (card.querySelector('input[name="modo-1"]:checked') as HTMLInputElement)?.value;
  let value = parseInt(input.value.replace(/[^\d]/g, ''), 10);

  if (modo === 'gramos') {
    if (!value || value < 100) value = 100;
    input.value = `${value} g`;
  } else if (modo === 'pesos') {
    if (!value || value < 50) value = 50;
    input.value = `$${value}`;
  } else {
    if (!value || value < 1) value = 1;
    input.value = value.toString();
  }

  input.dataset.value = value.toString();
};

/* =========================
   PEDIDO ACTIVO
========================= */

window.getOrCreatePedido = function(): ActivePedido {
  if (!window.activePedido) {
    window.activePedido = {
      numero_pedido: Date.now(),
      telefono_cliente: "",
      fecha: new Date().toISOString(),
      pedido_detalle: []
    };
  }
  return window.activePedido;
}
declare global {
  interface Window {
    userPhone?: string;
    activePedido?: ActivePedido;
    getOrCreatePedido: () => ActivePedido;
  }
}
function addToPedido(product: Product, tipo: string) {
  const pedido = window.getOrCreatePedido();
    
    if(product.qty === 0){
      return;
    }
    pedido.pedido_detalle.push({
      id: Date.now(),
      cantidad: product.qty,
      precio_unitario: product.price,
      modo: product.modo,
      unidad: product.unidad || 'pza',
      tipo: tipo,
      producto: {
        id: product.id,
        nombre: product.name
      }
    });
}

/* =========================
   BOTON AGREGAR
========================= */

document.querySelectorAll('.add-cart-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const button = btn as HTMLButtonElement;
    const card = button.closest('.bg-white.rounded-2xl');
    if (!card) return;

    if (!window.userPhone) {
      alert('Ingresa tu teléfono');
      return;
    }

    const modo = (card.querySelector('input[name="modo-1"]:checked') as HTMLInputElement)?.value as "gramos" | "pesos" | undefined;
    const input = card.querySelector('input.qty-input') as HTMLInputElement;
    const tipo = card?.querySelector('input[type="radio"]:checked')?.getAttribute('value');
    let qty = parseInt(input.value.replace(/[^\d]/g, ''), 10) || 0;
    let base = parseFloat(button.dataset.priceKg || button.dataset.price || '0');

    let price = base;
    let cantidadFinal = qty;

    if (modo === 'gramos') {
      if (qty < 100) qty = 100;
      price = (qty / 1000) * base;
      cantidadFinal = qty;
      console.log(price);
    } else if (modo === 'pesos') {
      if (qty < 50) qty = 50;
      price = qty;
      cantidadFinal = Math.round((qty / base) * 1000);
      console.log(price);
    }

    const product: Product = {
      id: Number(button.dataset.id),
      name: button.dataset.name!,
      price: Number(price.toFixed(2)),
      qty: cantidadFinal,
      modo: modo as "gramos" | "pesos" | undefined,
      tipo: tipo || '',
      unidad: modo ? 'g' : 'pza'
    };
    
    addToPedido(product, tipo || '');
    window.updateCartCount();
    input.value = modo === 'gramos' ? '100 g' : modo === 'pesos' ? '$50' : '0';
    input.dataset.value = input.value.replace(/[^\d]/g, '');
  });
});

document.addEventListener('DOMContentLoaded', function() {
  const radios = document.querySelectorAll('input[name="modo-1"]');
  radios.forEach(radio => {
    radio.addEventListener('change', function(this: HTMLInputElement) {
      actualizarInputPorModo(this);
    });
  });
});

function actualizarInputPorModo(radio: HTMLInputElement) {
  const card = radio.closest('.bg-white.rounded-2xl');
  if (!card) return;
  const input = card.querySelector('input.qty-input') as HTMLInputElement;
  if (!input) return;

  const modo = radio.value;
  let numericValue = parseInt(input.value.replace(/[^\d]/g, ''), 10);

    numericValue = modo === 'gramos' ? 100 : 50;

  if (modo === 'gramos') {
    if (numericValue < 100) numericValue = 100;
    input.value = `${numericValue} g`;
  } else if (modo === 'pesos') {
    if (numericValue < 50) numericValue = 50;
    input.value = `$${numericValue}`;
  }

  input.dataset.value = numericValue.toString();
}
</script>